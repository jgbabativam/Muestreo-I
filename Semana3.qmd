---
title: "Muestreo Probabilístico"
subtitle: "Maestría en Estadística y Ciencia de datos"
author: "[Giovany Babativa, PhD](http://jgbabativam.rbind.io/)"
format: 
  gbabativa-revealjs:
    footer: "Diapositivas disponibles en [GitHub](https://github.com/jgbabativam)."
    logo: "images/UNIVlogo.png"
incremental: false
embed-resources: true
highlight-style: dracula
execute: 
  echo: false
  eval: true
filters:
  - webr
revealjs-plugins:
  - drop
---

## Sobre Mi

<div style="text-align: justify;">

PhD en Estadística, MSc en Big Data, MSc en Estadística.  Con 20 años de experiencia, actual director de analítica en el CNC, miembro del comité de expertos en pobreza en el DANE y consultor de la División de Estadística de la CEPAL. Ex-decano de la Facultad de Estadística USTA, ex-director de operaciones en el ICFES,...

> Puedes encontrarme en:

- {{< ai google-scholar >}} [Google scholar](https://scholar.google.es/citations?user=2NJRNg8AAAAJ&hl=es)
- {{< fa brands github >}} [GitHub. https://github.com/jgbabativam](https://github.com/jgbabativam)
- {{< fa brands linkedin >}} [linkedin](https://www.linkedin.com/in/giovany-babativa-marquez/?originalSubdomain=co)
- {{< fa solid envelope >}} j.babativamarquez@uniandes.edu.co

</div>



# MUESTREO PROBABILÍSTICO {background-color="#0077b6"}

## Notación

<br><br>

<div style="text-align: justify;">

Defina a $U$ un universo^[En adelante se denominará universo a la población objetivo.] de elementos $\{U_1,\ldots,U_N\}$ **finito** y **conocido** de antemano con una variable de interés $Y$ que toma valores $\{y_1,\ldots,y_N\}$. Sea el parámetro $\theta$ (medida del universo) una función de $(y_1,\ldots,y_N)$ de esta manera a $\theta(y_1,\ldots,y_N)$ se denomina parámetro y se denota $\theta$.

</div> 


## Probabilidades de Inclusión

<br>

Se define probabilidad de inclusión de primer orden del elemento $k$

$$\pi_k=\sum_{k \in s_i}p(s_i)$$

. . . 

Sea:

$$I_k=\begin{cases}1 \hspace{0.3cm} \text{si $k \in s$} \\
0 \hspace{0.3cm} \text{en otro caso}\end{cases}$$

. . . 

Entonces $\pi_k=P(I_k=1)$


## Parámetros de interés

Para un universo $U$ de tamaño $N$, sea $y$ la característica de interés, entonces podríamos estar interesados en:

- **Total**: $t_y=\sum_Uy_k$ (personas con cierta enfermedad)
- **Media**: $\overline{y}_U=\frac{\sum_Uy_k}{N}=\frac{t_y}{N}$ (dinero)
- **Proporción**: $p_U=\frac{\sum_Uy_k}{N}=\frac{t_y}{N}$ para $y_k=\{1,0\}$ (desplazados)
- **Razón**: $R=\frac{t_y}{t_z}$. Unidades del producto por establecimiento con la intención de venderlo.

. . . 

Nótese que todos los parámetros pueden ser expresados como función de totales, por tanto hay un particular interés encontrar estimadores para este parámetro.


## Estimador de Horvitz-Thompson (1952)

Para un universo $U$ se desea estimar el total de una característica de interés $y$ denotado como $t_y$. Por ejemplo,

Para $\theta=t_y=\sum_Uy_k$ se define: 
$$\widehat{\theta}=\widehat{t}_{y,\pi}=\sum_{s_i}\frac{y_k}{\pi_k}$$

$\frac{1}{\pi_k}$ se denomina \textbf{\textit{Factor de expansión}}

. . . 

Cada elemento se representa a sí mismo y a una fracción de la población.


## Estimador de Horvitz-Thompson (1952) 

**Muestreo Aleatorio Simple**

<br>

- $\widehat{t}_{y,\pi}=\sum_{s_i}\frac{y_k}{\pi_k}=\frac{N}{n}\sum_{s_i}y_k$
- $V_{MAS}(\widehat{t}_{y,\pi})=\frac{N^2}{n}\left(1-\frac{n}{N}\right)S^2_{yU}$
- $\widehat{V}_{MAS}(\widehat{t}_{y,\pi})=\frac{N^2}{n}\left(1-\frac{n}{N}\right)S^2_{ys_i}$

## Estimador de Horvitz-Thompson (1952) 

**Muestreo Bernoulli**

<br>

- $\widehat{t}_{y,\pi}=\sum_{s_i}\frac{y_k}{\pi_k}=\sum_{s_i}\frac{y_k}{\pi}$
- $V_{Ber}(\widehat{t}_{y,\pi})=\left(\frac{1}{\pi}-1\right)\sum_Uy^2_k$
- $\widehat{V}_{Ber}(\widehat{t}_{y,\pi})=\frac{1}{\pi}\left(\frac{1}{\pi}-1\right)\sum_{s_i}y^2_k$


## Estimación de la media poblacional 

**Muestreo Aleatorio Simple**

<br>

- $\widehat{\overline{y}}_U=\frac{\widehat{t}_{y,\pi}}{N}$
- $V_{MAS}(\widehat{\overline{y}}_U)=\frac{1}{n}\left(1-\frac{n}{N}\right)S^2_{yU}$
- $\widehat{V}_{MAS}(\widehat{\overline{y}}_U)=\frac{1}{n}\left(1-\frac{n}{N}\right)S^2_{ys_i}$

. . . 

Al factor $\left(1-\frac{n}{N}\right)$ se le conoce como factor de corrección para poblaciones finitas.


## Estimador de Hansen-Hurwitz (1943)

<br><br>

$$\widehat{t}_{y,MCR}=\frac{1}{m}\sum_{i=1}^m\frac{y_{k_i}}{p_{k_i}}$$

En donde $p_{k_i}$ es la probabilidad de selección del elemento $k$. Cada elemento se representa así mismo y al resto del universo $\rightarrow$ promedio.


## Estimador de Hansen-Hurwitz (1943)

<br><br>
- $V\left(\widehat{t}_{y,MCR}\right)=\frac{1}{m}\sum_Up_k\left(\frac{y_k}{p_k}-t_y\right)^2$

- $\widehat{V}\left(\widehat{t}_{y,MCR}\right)=\frac{1}{m(m-1)}\sum_{i=1}^m\left(\frac{y_{k_i}}{p_{k_i}}-\widehat{t}_{y,MCR}\right)^2$ 

- $E\left(\widehat{V}\left(\widehat{t}_{y,MCR}\right)\right)=V\left(\widehat{t}_{y,MCR}\right)$


# ESTIMACIÓN {background-color="#0077b6"}

 
## Estimación de un dominio

<br><br>

<div style="text-align: justify;">

Con frecuencia se desean estimaciones de subpoblaciones no consideradas dentro del diseño muestral, dicha subpoblación es denominada un **dominio**, en general no sabemos cuántos elementos pertenecen a un dominio hasta obtener los resultados de la muestra. Por ejemplo, al diseñar una muestra para medir la intención de voto de los Colombianos el interés se centra en conocer el total de personas que votarán por los diferentes candidatos pero previo a los resultados no se conoce cuántos votarán por cada uno.

</div> 


## Estimación de un dominio: Notación

El total de un dominio es: 

$$\sum_{U_d}y_k$$

con $U_d$ la población que compone al dominio.

Sea $$y_{dk}=\begin{cases}y_k \hspace{0.2cm}\text{si } k\in U_d \\ 0 \hspace{0.4cm} \text{en otro caso}\end{cases}$$

## Estimación de un dominio: Notación

<br>

Así $t_{yd}=\sum_{U}y_{dk}$ será el total de la variable de interés.

. . . 

<br>
Si $y_{dk}=1$ cuando $k \in U_d$ entonces $N_d=\sum_Uy_{k_d}$ es el tamaño poblacional del dominio.

. . . 

<br>
Luego la media del dominio es: $$\overline{y}_{Ud}=\frac{t_{yd}}{N_d}$$

## Estimación de un dominio: Ejemplo

- A nivel general el estimador de Horvitz-Thompson es:
$$\widehat{t}_{yd}=\sum_{s}\frac{y_{dk}}{\pi_k}$$
- Particularmente para MAS se tiene que:
$$\widehat{t}_{yd}=\frac{N}{n}\sum_{s}y_{dk}$$

$$\widehat{V}(\widehat{t}_{yd})=\frac{N^2}{n}\left(1-\frac{n}{N}\right)S^2_{y_ds}$$

## Estimación de un dominio: Aplicación

**Ejemplo:**  
Suponga que por medio de un muestreo a hogares se desea determinar la estructura del gasto según los ingresos familiares. El cliente desea estimar un cuadro de salida así:

```{r}
library(kableExtra)

data.frame(
  "Gasto" = c("Vivienda", "Alimentación", "Educación", "Transporte", "Esparcimiento", "Otros", "Total"),
  "Total < 2 SMMLV" = rep("", 7),
  "CVE (%) < 2 SMMLV" = rep("", 7),
  "Total 2 a 4 SMMLV" = rep("", 7),
  "CVE (%) 2 a 4 SMMLV" = rep("", 7),
  "Total > 4 SMMLV" = rep("", 7),
  "CVE (%) > 4 SMMLV" = rep("", 7),
  "Total General" = rep("", 7),
  "CVE (%) Total" = rep("", 7)
) %>% janitor::clean_names() |> 
  kbl(align = "lrrrrrrrr", booktabs = TRUE, linesep = "", caption = "Total de gasto de las familias en la población según ingresos familiares.") %>%
  kable_styling(full_width = TRUE, font_size = 16)

```

## Estimación de un dominio: Aplicación

1. _Ejemplo Hogares - Marco Muestral.xls_ seleccione una muestra por $MAS(N, 10)$.
2. _Dominio Hogares.xls_ estime en Excel el cuadro de salida solicitado por el cliente.
3. _Dominio Hogares.xls_ asigne arbitrariamente los códigos de hogares seleccionados en el literal 1 y documente la base.
4. _Dominio Hogares.xls_ suba los datos a _R_.
5. Haga un cruce de los datos con la muestra y la base con la información levantada de tal forma que los pesos muestrales queden en el archivo _Dominio Hogares.xls_.
6. Estime en **R** el cuadro de salida solicitado por el cliente.


```{r}
library(countdown)
countdown(minutes = 35, seconds = 00,  right = 0)
```

## Estimación de un dominio: Aplicación

<span style="color:#FF8D21"> Tu turno </span>

<div style="text-align: justify;">

Lohr (1999) En el censo de Agricultura de Estados Unidos que se realiza cada 5 años, se reúnen datos de todas las fincas-granjas donde se producen y venden más de \$100.000 USD en productos agrícolas al mes. Dentro de las variables que se miden está el número de granjas y los acres^[Un acre es una medida de superficie usada en agricultura equivalente a 43560 $pies^2$] dedicados a las granjas. El archivo **agpop.sav** contiene los datos de la población medida en el censo de $N=3078$. El archivo **Agrsrs.sav** contiene los datos de una muestra obtenida mediante el diseño $MAS(3078, 300)$. Estime el promedio y la cantidad de acres dedicados a la agricultura en el año 1992 en los Estados Unidos.

</div>

## Codigo R

Cargue de los datos

```{r, echo=TRUE}
#remotes::install_github("tidy-survey-r/srvyrexploR")
library(pacman)
p_load(tidyverse, survey, srvyr, remotes, haven, srvyrexploR, skimr)

censo <- "https://github.com/jgbabativam/Muestreo-I/raw/main/datos/agpop.sav"
encuesta <- "https://github.com/jgbabativam/Muestreo-I/raw/main/datos/Agrsrs.sav"

marco <- read_sav(censo)
datos <- read_sav(encuesta)
```

Explore los datos usando `skim()` y `glimpse()`

## Codigo R: Objeto de diseño

<br><br>
```{r, echo=TRUE}

datos$FEXP <- nrow(marco)/nrow(datos)

dsg <- datos |> 
       mutate(NI = nrow(marco)) |> 
       as_survey_design(ids = 1,
                        fpc = NI,
                        weights = FEXP,
                        nest = T)
```

## Codigo R: Estimación

<br><br>

```{r, echo=TRUE}

(estimacion <- dsg |> 
                 summarise(Total = survey_total(acres92, vartype = c("se", "cv", "ci")),
                           Promedio = survey_mean(acres92, vartype = c("se", "cv", "ci"))))

ty <- sum(marco$acres92)
ybU <- mean(marco$acres92)
```

. . . 

¿Cómo estimaría el la proporción de condados con menos de 200.000 acres de granjas?. ¿A partir de los universos del marco, cree que esta fue una buena muestra?

## Estimación de un dominio: Promedio

**MAS**


- $\overline{y}_{Ud}=\frac{t_{yd}}{N_d}=\frac{N/n\sum_{U}y_{dk}}{N_d}$
- $\overline{y}_{sd}=\frac{\widehat{t}_{yd}}{\widehat{N}_d}=\frac{N/n\sum_{s}y_{dk}}{N/n\sum_{s}z_{dk}}=\frac{\sum_{s}y_{dk}}{n_d}$, con $z_{dk}=1$ si $k \in U_d$

. . . 

Puesto que la cantidad del numerador y del denominador son variables aleatorias el estimador se denomina de razón y la estimación de la varianza se obtiene por aproximación mediante el método de linealización de Taylor.

## Estimación de un dominio: Promedio

<span style="color:#FF8D21"> Tu turno </span>

<br><br>

Para cada región estime el promedio y el total de acres por condado en 1992. 

```{r}
library(countdown)
countdown(minutes = 5, seconds = 00,  right = 0)
```

# TAMAÑO DE LA MUESTRA {background-color="#0077b6"}

## Tamaño de Muestra y asignación por estrato

En general no existe una fórmula mágica que indique el tamaño de muestra apropiado sino que éste debe ser establecido de acuerdo a la estrategia muestral seleccionada.

Se debe controlar la **precisión** y la **confiabilidad**, tenga en cuenta que bajo un diseño muestral $P(\cdot)$ un intervalo de confianza de $100(1-\alpha)\%$ para la media poblacional está dado por:
$$\left(\overline{y}_s-\underbrace{z_{1-\alpha/2}\sqrt{V_P(\overline{y}_s)}}_\text{margen de error}, \overline{y}_s+\underbrace{z_{1-\alpha/2}\sqrt{V_P(\overline{y}_s)}}_\text{margen de error}\right)$$

## Tamaño de Muestra

Recuerde que por T.C.L se tiene que $\sum_iX_i$ sigue una distribución normal y por tanto:

\begin{align*}
P\left(-z_{1-\alpha/2}<\frac{\overline{y}_s-\overline{y}_U}{\sqrt{V_P(\overline{y}_s)}}<z_{1-\alpha/2}\right)=1-\alpha \\ 
P\left(\left|\overline{y}_s-\overline{y}_U\right|<z_{1-\alpha/2}\sqrt{V_P(\overline{y}_s)}\right)=1-\alpha \\ 
P\left(\left|\overline{y}_s-\overline{y}_U\right|<e\right)=1-\alpha
\end{align*} 

. . . 

La cantidad a minimizar es $e$. En encuestas donde el parámetro de interés es una proporción se sugiere $e=0.03$ y $1-\alpha=0.95$.


## Ejemplo: M.A.S.

En $MAS$:
$$\widehat{V}(\overline{y}_s)=\frac{1}{n}\left(1-\frac{n}{N}\right)S^2_{y_s}$$ 

. . . 

Un intervalo de confianza del $100(1-\alpha)\%$ para $\overline{y}_U$ bajo diseño $MAS$ es: 

. . . 

$$\overline{y}_s\pm \underbrace{z_{1-\alpha/2}\sqrt{\frac{1}{n}\left(1-\frac{n}{N}\right)S^2_{y_s}}}_e$$ 

## Ejemplo: M.A.S.

Se desea: 
$$z_{1-\alpha/2}\sqrt{\frac{1}{n}\left(1-\frac{n}{N}\right)S^2_{y_s}}<e$$

. . . 

Al despejar $n$ se obtiene:

\begin{align}\label{tamMue}
n&>\frac{z_{1-\alpha/2}^2S^2_{y_s}}{e^2+\frac{z_{1-\alpha/2}^2S^2_{y_s}}{N}}\\ 
&=\frac{n_0}{1+\frac{n_0}{N}}
\end{align} 

con $n_0=\frac{z_{1-\alpha/2}^2S^2_{y_s}}{e^2}$.


## Ejemplo M.A.S. caso Proporción

Suponga que en un municipio de $N=1251$ habitantes se desea estimar la proporción de personas que piensan votar por un determinado candidato, para ello se aplicará un muestreo aleatorio simple y se desea obtener un margen de error máximo del $3\%$ con una confiabilidad de $95\%$. Calcule el tamaño de muestra que debe utilizarse en el proyecto. 

. . . 

<div style="font-size: 0.6em;">

\begin{align*}
S^2_{y}&=\frac{1}{N-1}\sum_U\left(y_k-\overline{y}_U\right)^2 \\
&=\frac{1}{N-1}\left(\sum_Uy_k^2-N\overline{y}_U^2\right) \\
&=\frac{N}{N-1}P_d\left(1-P_d\right)\doteq P_d\left(1-P_d\right)
\end{align*} 

</div>

_Graficar la función para determinar valor adecuado de $P_d$._




## Tamaño de Muestra: M.A.S. - Proporción 

$$n_0=\frac{1.96^2(0.5)(1-0.5)}{0.03^2}\approx 1067$$

. . . 

Entonces el tamaño de muestra requerido es: 

. . . 

$$n=\frac{1067}{1+\frac{1067}{1251}}=576$$ 

. . . 

Note que $n_0$ corresponde al tamaño de muestra al ignorar la corrección para poblaciones finitas. 


## Ejercicio

<span style="color:#FF8D21"> Tu turno </span>

Suponga varios márgenes de error y grafique la función de tamaños de muestra para este ejercicio. Luego suponga un universo más grande y haga el mismo ejercicio ¿En términos proporcionales que puede decir del tamaño de la muestra frente al universo en ambos ejercicios?

## Tamaño de Muestra: M.A.S. - Medias, Totales 

<br>
En el caso de estimación de la media o de totales es necesario considerar una precisión relativa, siguiendo los mismo pasos se llega a:

$$P\left(\left|\frac{\overline{y}_s-\overline{y}_U}{\overline{y}_U}\right|<e\right)=1-\alpha$$
$$P\left(|\overline{y}_s-\overline{y}_U|<e|\overline{y}_U|\right)=1-\alpha$$
Así que en la fórmula del tamaño de la muestra se debe reemplazar $e$ por $e|\overline{y}_U|$.


## Tamaño de Muestra: M.A.S. - Medias, Totales 

<br>

\begin{align}
n&=\frac{z^2_{1-\alpha/2}S^2_{y}}{\left(e\overline{y}_U\right)^2+\frac{z^2_{1-\alpha/2}S^2_{y}}{N}} \\[0.4cm]
 &=\frac{z^2_{1-\alpha/2}CV^2(y)}{e^2+\frac{z^2_{1-\alpha/2}CV^2(y)}{N}}
\end{align}

## Tamaño de Muestra: M.A.S. - Medias, Totales 

Use la base \textit{agpop.sav} y extraiga una muestra aleatoria simple de tamaño $n=40$, asuma que esta fue una muestra piloto utilizada para validar las herramientas de medición pero a partir de ella también puede estimar el comportamiento de las variables de interés para hallar el $CV(y)$. Suponga que se desea un error relativo inferior al $10\%$ determine el tamaño de la muestra que necesitaría para ejecutar el proyecto.

## Tamaño de Muestra: Observaciones

<br>

- Para hacer los cálculos de tamaño de muestra use una prueba piloto de la investigación. Lorh (2000) establece que este es probablemente el mejor método.
- Use información secundaria, es raro que sea la primera vez que se estudie algo relativo a su investigación. Es posible tener acceso a fuentes administrativas (Ejemplo: DANE, Ministerios, etc) que pueden tener estimaciones de la varianza de cifras relacionadas con el estudio.

## Tamaño de Muestra: Observaciones

<br>

- Use una distribución empírica para estimar la varianza. Por ejemplo, algunos autores sugieren que las variables económicas suelen tener distribuciones sesgadas a la derecha que pueden modelarse con distribuciones chi-cuadrado.
- En la medida que el diseño muestral se vuelve más complejo (estratificado, multietápico de conglomerados o elementos en algunas etapas) no es tan fácil llegar a fórmulas que proporcionen el tamaño de muestra adecuado, así que es necesario recurrir a métodos de Monte Carlo para hallar los tamaños de muestra basados en las fórmulas de la varianza del diseño muestral.

## Tamaño de muestra en diseños complejos

<br>

$$n \geq \frac{z_{1-\alpha/2}^2 S^2_y DEFF}{\varepsilon^2+\frac{z_{1-\alpha/2}^2 S^2_y DEFF}{N} } $$


. . . 

$$DEFF = \frac{V_{P}(\hat{\theta})}{V_{MAS}(\hat{\theta})} $$


# MUESTREO ESTRATIFICADO {background-color="#0077b6"}

## Definiciones

1. $U=\{1,2,\ldots,N\}$ sea $\{U_1, U_2, \ldots, U_H\}$ una partición de $U$.
2. $U_h, h=1,\ldots,H$ se aplica de forma **INDEPENDIENTE** el diseño muestral $P_h(\cdot)$.
3. $t_y=\sum_Uy_k=\sum_{h=1}^Ht_{yh}$ de tal manera que el estimador insesgado de $t_y$ es:

\begin{align*}
\widehat{t}_y=\sum_{h=1}^H\widehat{t}_{yh}
\end{align*}

\begin{align*}
\widehat{V}\left(\widehat{t}_y\right)=\widehat{V}\left(\sum_{h=1}^H\widehat{t}_{yh}\right)=\sum_{h=1}^H\widehat{V}\left(\widehat{t}_{yh}\right)
\end{align*}

## Observaciones

1. Cada estrato $U_h$ es de tamaño $N_h$, así $\sum_{h=1}^HN_h=N$.
2. Una partición de $U$ es:
 - $N_h\neq0, h=1,\ldots,H.$
 - $U_i \bigcap U_j=\emptyset, i\neq j; i,j=1,\ldots,H$
 - $\bigcup_{h=1}^HU_h=U$
 
3. **Estrato es diferente de dominio**, los estratos se construyen a partir del diseño de la muestra, los dominios no. Por tanto la manera de hacer estimación es diferente.

## Razones para estratificar

<div style="text-align: justify;">

1. Minimizar varianza. Por ejemplo, el DANE en las encuestas económicas estratifica por empresas grandes, medianas y pequeñas.
2. Necesidad de contar con información con alta precisión para algunos niveles de desagregación. Por ejemplo, en un estudio en Bogotá se desean estimaciones por localidad pero de no controlarse la muestra es posible que salgan muy pocos elementos para algunas localidades. 
3. Reducción de costos. Por ejemplo, los gastos de desplazamiento pueden llegar a aumentar de manera considerable los costos de un proyecto entonces es posible estratificar por ciudades grandes, intermedias y pequeñas.

</div>

## Problemas técnicos de estratificar

<div style="text-align: justify;">

1. La cantidad de estratos es inversamente proporcional a la varianza y proporcional a los costos. En general al llegar a determinado número de estratos no se gana mucho en disminuir varianza y por el contrario se invierte mucho dinero.
2. Delimitación de los estratos (Hidroglou, Dalenius, Análisis multivariante de clúster).
3. Variable de estratificación - ¿con respecto a qué variable se debe estratificar?.
4. Asignación de muestra por estratos.

</div>

## Muestreo ESTMAS

Un caso particular es cuando se estratifica y cada uno de los estratos se aplica de manera independiente un $MAS(N_h,n_h)$. Encuesta de Anual de servicios, manufacturera y comercio (DANE).

1. $\widehat{t}_{yh}=\sum_{sh}\frac{N_h}{n_h}y_k$
2. $\widehat{t}_{y}=\sum_{h=1}^H\widehat{t}_{yh}=\sum_{h=1}^H\sum_{sh}\frac{N_h}{n_h}y_k$
3. $\widehat{V}\left(\widehat{t}_{yh}\right)=\frac{N_h^2}{n_h}\left(1-\frac{n_h}{N_h}\right)S^2_{ysh}$
4. $\widehat{V}\left(\widehat{t}_{y}\right)=\sum_{h=1}^H\widehat{V}\left(\widehat{t}_{yh}\right)=\sum_{h=1}^H\frac{N_h^2}{n_h}\left(1-\frac{n_h}{N_h}\right)S^2_{ysh}$ 

## Ejercicio

<span style="color:#FF8D21"> Tu turno </span>

Use las bases **Agpop.sav** y **AgStrat.sav** que corresponde a una muestra usando un diseño ESTMAS y realice los siguientes ejercicios:

1. Seleccione una muestra de **Agpop.sav** teniendo en cuenta los mismos $n_h$ de **AgStrat.sav**
2. Estime el promedio de acres por región con sus respectivos errores de muestreo (hágalo sacando las medidas de resumen $N_h$, $n_h$, $S^2$).
3. Estime en R el promedio de acres por región con sus respectivos errores de muestreo.

## Ejercicio

Suponga que se planea un muestreo estratificado que permita medir la intención de voto de los colombianos en las próximas elecciones presidenciales. Se ha decidido partir la población en 3 estratos. El analista Estadístico propone hacer en la primera etapa los siguientes diseños muestrales:


- Estrato 1: Diseño de inclusión forzosa (censo).
- Estrato 2: Diseño de Probabilidad Proporcional al Tamaño (PPT), $x_k$ es la población de 18 años o más en cada ciudad.
- Estrato 3: Muestreo Aleatorio Simple.

. . . 

Determine las fórmulas necesarias para calcular el total (con su cve) de personas que votarán en las próximas elecciones. ¿Cómo estimaría la proporción de personas que están a favor del candidato $A$?.

## Ejercicio

Se realizó un muestreo de sedes educativas mediante un diseño ESTMAS estratificando por NSE. Con el objetivo de hacer auditoria de los recursos del estado, se investigó por la cantidad de dinero (en millones de pesos) que el estado había girado a los colegios, los resultados son:

<div style="font-size: 0.6em;">

 **NSE** |  $N_h$ | $n_h$ | $\sum_{s_h}y_k$ | $s^2_{yh}$ |
|---------|-----------|-----------|---------------------|----------------|
| 1       | 400       | 98        | 2361.8             | 5575           |
| 2       | 30        | 10        | 256                | 4064           |
| 3       | 61        | 37        | 9901.2             | 347556         |
| 4       | 18        | 6         | 1074               | 22798          |
| 5       | 70        | 39        | 11454.3            | 123578         |
| 6       | 120       | 21        | 697.2              | 9795           |

</div>

Estime el total de recursos girados a los colegios de la población y por NSE, calcule intervalos de confianza al 95\% y muestre los cve.


## Ejercicio

Se desea lanzar un nuevo producto a un target específico pero se desea saber si la preferencia depende del género para tomar una decisión sobre como enfocar la publicidad. A partir de un muestreo ESTMAS se levantaron los siguientes datos:

<div style="font-size: 0.6em;">

**Ciudad** | $N_h$ | $n_h$ | **Mujeres (%)**  
|----------|-------|-------|-----------------|
| Medellín | 9100  | 636   | 38              |
| Ibagué   | 1950  | 451   | 27              |
| Barranquilla | 5500 | 481 | 18              |
| Bogotá   | 10850 | 611   | 19              |
| Cúcuta   | 2100  | 493   | 36              |
| Bucaramanga | 5500 | 575 | 13              |
| Cali     | 9000  | 588   | 26              |

</div>

Estime la proporción de mujeres de la población que preferirán el producto, calcule el cve.
 

## Ejercicio

Para el ejercicio de los acres del censo de agricultura de Estados Unidos suponga que se hace un muestreo ESTMAS así:

<br>

<div style="font-size: 0.8em;">


**Estrato**    | **Nro. Granj** | **Muestra** |
|--------------|----------------|-------------|
|Noroeste (NE) |        220     |         21  |
|Norte-Centro (NC) |       1054 |        103 |
|   Sur (S) |       1382  |        135 |
| Oeste (W) |        422    |           41 |
| Total     |       3078  |        300 |


</div>

## Ejercicio

<br>

1. Use R para extraer una muestra del archivo **agpop.sav** bajo el diseño propuesto.
2. Usando el archivo **agstrat.sav** estime el total de acres dedicados a la agricultura dentro de cada región.
3. Compare la estrategia de dominios vs estratos usando efecto de diseño. Concluya.


## Asignación de Muestra por Estrato

<br>

Con frecuencia se requiere controlar la muestra con el fin de disminuir varianza, garantizar dispersión, entre otros. Si ya se tiene calculado un tamaño de muestra global (para obtener resultados a nivel general y no por estrato) se pueden asignar los tamaños de muestra de diferentes maneras según el objetivo que se busque. Debe tener en cuenta que si su objetivo es comparar los resultados entre los diferentes estratos debe calcular un tamaño de muestra de forma independiente para cada estrato y así garantizar una precisión determinada en cada estrato.


## Afijación Proporcional

<br>

Se debe usar cuando se puede suponer que la variable de interés tiene varianzas similares en todos los estratos. 

. . . 

$$n_j=n*\frac{N_jS^2_{U_j}}{\sum_{h=1}^HN_hS^2_{U_h}}=n*\frac{N_j}{\sum_{h=1}^HN_h}=n*\frac{N_j}{N}$$
. . . 

Muy usada a menudo pero sin probar que $S^2_{y_{U_h}}=S^2_{y_h}$ lo cual evidentemente está mal.

## Afijación Proporcional

<br>

Para la muestra de **agStrat** calcule un tamaño de muestra global y asigne los tamaños de muestra por estrato de manera proporcional. Discuta el procedimiento.


## Afijación $X$-óptima

<br>

Se debe usar cuando $S^2_h$ varían mucho. El objetivo de la asignación óptima consiste obtener la mayor cantidad de información al menor costo. Se debe contar con $x$ altamente correlacionado con $y$ o con una prueba piloto. La función de costo: 

. . . 

$$C=c_0+\sum_{h=1}^Hn_hc_h,$$ 

## Afijación $X$-óptima

<br>

con $C$ el costo total, $c_0$ los costos adicionales y $c_h$ el costo en el estrato $h$ que varía dependiendo de $h$. 

$$n_j=n*\left(\frac{\frac{N_jS_{x_j}}{\sqrt{c_j}}}{\frac{\sum_{h=1}^HN_hS_{x_h}}{\sqrt{c_h}}}\right)$$

## Afijación de Neyman

<br>

Es un caso particular de la asignación óptima y se usa si $c_h=c_f$, es decir, los costos son constantes para todos los estratos.

$$n_j=n*\left(\frac{N_jS_{x_j}}{\sum_{h=1}^HN_hS_{x_h}}\right)$$

En general esta asignación proporciona un estimador con menor varianza que la asignación proporcional.

## Afijación Proporcional al Tamaño

<br>

Es una variación de la asignación proporcional, se usa si se cumple que el coeficiente de variación $CV_h=CV_f$ para todos los estratos:

$$n_j=n*\frac{t_{X_{U_j}}}{t_{X}}$$

## Afijación de potencia

<br>

Sea $0\leq \alpha \leq 1$ entonces:

$$n_j=n*\frac{t^\alpha_{X_{U_j}}}{\sum_{h=1}^Ht^\alpha_{X_h}}$$

Analice los casos $\alpha=1$ y $\alpha=0$. 

## Delimitación de los estratos

<br>

En muestreo estratificado se busca homogeneidad dentro y heterogeneidad entre estratos. Este es un problema de clasificación que se puede resolver mediante métodos multivariados (cluster analysis). Sin embargo en muestreo se han establecido algunos métodos como:


- Caso $IF-MAS$: Método de Hidroglou (1986).
- Método de Dalenius y Hodges (1957).
- LH
- Geométrico

## Delimitación de los estratos

Usando la base **Delimitación de estratos.xls** defina subconjuntos de 2 y 3 estratos usando los siguientes métodos:

- Algoritmo de conglomerados jerárquicos.
- Algoritmo de conglomerados de $K-$medias.
- Hidroglou.
- Dalenius y Hodges.

# MUESTREO DE CONGLOMERADOS Y BIETAPICO {background-color="#0077b6"}

## Introducción

Hemos visto muestreos donde la población está al alcance por medio de un marco de lista. Sin embargo, en la mayoría de situaciones esto no ocurre y se debe llegar a la unidad de observación a partir de unidades de muestreo que las contengan. 

. . . 

Suponga que desea estimar el porcentaje de estudiantes de colegios que han sido víctimas de algún tipo de agresión, claramente usted no tiene acceso a un listado de todos los estudiantes de todos los colegios (marco de lista), pero si puede tener acceso al listado de colegios y direcciones (marco de áreas) haciendo un derecho de petición a la secretaría de educación que corresponda o al Ministerio de Educación Nacional.


## Muestreo de Conglomerados y Muestreo Bietápico

Entonces usted puede seleccionar $n_I$ colegios y hacer a todos los estudiantes o seleccionar $n_i$ colegios y hacer $n_j$ estudiantes en cada colegio.

1. La primera situación se denomina: **Muestreo de Conglomerados** y consiste en que una vez seleccionada una unidad de muestreo se aplica censo.
2. La segunda situación se denomina: **Muestreo Bietápico** y consiste en que una vez seleccionada una unidad de muestreo se selecciona otra muestra al interior manteniendo algunos principios fundamentales.

En este ejemplo el colegio es la unidad de muestreo, siendo también el conglomerado en la primera situación y para ambos casos el estudiante es la unidad de observación.



```{r}
#pagedown::chrome_print("path-to-file.html")
```

# GRACIAS! {background-color="#ddf3ff"}

# Referencias

- Gutiérrez, H. A. (2016). Estrategias de muestreo: Diseño de encuestas y estimación de parámetros. Ediciones de la U.

- Lohr, S. L. (2021). Sampling: design and analysis. Chapman and Hall/CRC.

- Särndal, C. E., Swensson, B., & Wretman, J. (2003). Model assisted survey sampling. Springer Science & Business Media.

- Valliant, R., Dever, J. A., & Kreuter, F. (2013). Practical tools for designing and weighting survey samples (Vol. 1). New York: Springer.


# Citación y derechos de autor

Este material ha sido creado por [Giovany Babativa-Márquez](https://github.com/jgbabativam) y es de libre distribución bajo la licencia [Creative Commons Attribution-ShareAlike 4.0](https://creativecommons.org/licenses/by-sa/4.0/).

Si se copia parcial o totalmente, debe citar la fuente como:

> Babativa-Márquez, J.G. *Diapositivas del curso de muestreo probabilístico*. URL: https://jgbabativam.github.io/Muestreo-I/Semana3.html. 2024.
