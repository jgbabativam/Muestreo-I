---
title: "Muestreo Probabilístico"
subtitle: "Maestría en Estadística y Ciencia de datos"
author: "[Giovany Babativa, PhD](http://jgbabativam.rbind.io/)"
format: 
  gbabativa-revealjs:
    footer: "Diapositivas disponibles en [GitHub](https://github.com/jgbabativam)."
    logo: "images/UNIVlogo.png"
incremental: false
embed-resources: true
highlight-style: dracula
execute: 
  echo: false
  eval: true
filters:
  - webr
revealjs-plugins:
  - drop
---

## Sobre Mi

<div style="text-align: justify;">

PhD en Estadística, MSc en Big Data, MSc en Estadística.  Con 20 años de experiencia, actual director de analítica en el CNC, miembro del comité de expertos en pobreza en el DANE y consultor de la División de Estadística de la CEPAL. Ex-decano de la Facultad de Estadística USTA, ex-director de operaciones en el ICFES,...

> Puedes encontrarme en:

- {{< ai google-scholar >}} [Google scholar](https://scholar.google.es/citations?user=2NJRNg8AAAAJ&hl=es)
- {{< fa brands github >}} [GitHub. https://github.com/jgbabativam](https://github.com/jgbabativam)
- {{< fa brands linkedin >}} [linkedin](https://www.linkedin.com/in/giovany-babativa-marquez/?originalSubdomain=co)
- {{< fa solid envelope >}} j.babativamarquez@uniandes.edu.co

</div>



# MUESTREO PROBABILÍSTICO {background-color="#0077b6"}

## Notación

<br><br>

<div style="text-align: justify;">

Defina a $U$ un universo^[En adelante se denominará universo a la población objetivo.] de elementos $\{U_1,\ldots,U_N\}$ **finito** y **conocido** de antemano con una variable de interés $Y$ que toma valores $\{y_1,\ldots,y_N\}$. Sea el parámetro $\theta$ (medida del universo) una función de $(y_1,\ldots,y_N)$ de esta manera a $\theta(y_1,\ldots,y_N)$ se denomina parámetro y se denota $\theta$.

</div> 


## Probabilidades de Inclusión

<br>

Se define probabilidad de inclusión de primer orden del elemento $k$

$$\pi_k=\sum_{k \in s_i}p(s_i)$$

. . . 

Sea:

$$I_k=\begin{cases}1 \hspace{0.3cm} \text{si $k \in s$} \\
0 \hspace{0.3cm} \text{en otro caso}\end{cases}$$

. . . 

Entonces $\pi_k=P(I_k=1)$


## Parámetros de interés

Para un universo $U$ de tamaño $N$, sea $y$ la característica de interés, entonces podríamos estar interesados en:

- **Total**: $t_y=\sum_Uy_k$ (personas con cierta enfermedad)
- **Media**: $\overline{y}_U=\frac{\sum_Uy_k}{N}=\frac{t_y}{N}$ (dinero)
- **Proporción**: $p_U=\frac{\sum_Uy_k}{N}=\frac{t_y}{N}$ para $y_k=\{1,0\}$ (desplazados)
- **Razón**: $R=\frac{t_y}{t_z}$. Unidades del producto por establecimiento con la intención de venderlo.

. . . 

Nótese que todos los parámetros pueden ser expresados como función de totales, por tanto hay un particular interés encontrar estimadores para este parámetro.


## Estimador de Horvitz-Thompson (1952)

Para un universo $U$ se desea estimar el total de una característica de interés $y$ denotado como $t_y$. Por ejemplo,

Para $\theta=t_y=\sum_Uy_k$ se define: 
$$\widehat{\theta}=\widehat{t}_{y,\pi}=\sum_{s_i}\frac{y_k}{\pi_k}$$

$\frac{1}{\pi_k}$ se denomina \textbf{\textit{Factor de expansión}}

. . . 

Cada elemento se representa a sí mismo y a una fracción de la población.


## Estimador de Horvitz-Thompson (1952) 

**Muestreo Aleatorio Simple**

<br>

- $\widehat{t}_{y,\pi}=\sum_{s_i}\frac{y_k}{\pi_k}=\frac{N}{n}\sum_{s_i}y_k$
- $V_{MAS}(\widehat{t}_{y,\pi})=\frac{N^2}{n}\left(1-\frac{n}{N}\right)S^2_{yU}$
- $\widehat{V}_{MAS}(\widehat{t}_{y,\pi})=\frac{N^2}{n}\left(1-\frac{n}{N}\right)S^2_{ys_i}$

## Estimador de Horvitz-Thompson (1952) 

**Muestreo Bernoulli**

<br>

- $\widehat{t}_{y,\pi}=\sum_{s_i}\frac{y_k}{\pi_k}=\sum_{s_i}\frac{y_k}{\pi}$
- $V_{Ber}(\widehat{t}_{y,\pi})=\left(\frac{1}{\pi}-1\right)\sum_Uy^2_k$
- $\widehat{V}_{Ber}(\widehat{t}_{y,\pi})=\frac{1}{\pi}\left(\frac{1}{\pi}-1\right)\sum_{s_i}y^2_k$


## Estimación de la media poblacional 

**Muestreo Aleatorio Simple**

<br>

- $\widehat{\overline{y}}_U=\frac{\widehat{t}_{y,\pi}}{N}$
- $V_{MAS}(\widehat{\overline{y}}_U)=\frac{1}{n}\left(1-\frac{n}{N}\right)S^2_{yU}$
- $\widehat{V}_{MAS}(\widehat{\overline{y}}_U)=\frac{1}{n}\left(1-\frac{n}{N}\right)S^2_{ys_i}$

. . . 

Al factor $\left(1-\frac{n}{N}\right)$ se le conoce como factor de corrección para poblaciones finitas.


## Estimador de Hansen-Hurwitz (1943)

<br><br>

$$\widehat{t}_{y,MCR}=\frac{1}{m}\sum_{i=1}^m\frac{y_{k_i}}{p_{k_i}}$$

En donde $p_{k_i}$ es la probabilidad de selección del elemento $k$. Cada elemento se representa así mismo y al resto del universo $\rightarrow$ promedio.


## Estimador de Hansen-Hurwitz (1943)

<br><br>
- $V\left(\widehat{t}_{y,MCR}\right)=\frac{1}{m}\sum_Up_k\left(\frac{y_k}{p_k}-t_y\right)^2$

- $\widehat{V}\left(\widehat{t}_{y,MCR}\right)=\frac{1}{m(m-1)}\sum_{i=1}^m\left(\frac{y_{k_i}}{p_{k_i}}-\widehat{t}_{y,MCR}\right)^2$ 

- $E\left(\widehat{V}\left(\widehat{t}_{y,MCR}\right)\right)=V\left(\widehat{t}_{y,MCR}\right)$


# ESTIMACIÓN {background-color="#0077b6"}

 
## Estimación de un dominio

<br><br>

<div style="text-align: justify;">

Con frecuencia se desean estimaciones de subpoblaciones no consideradas dentro del diseño muestral, dicha subpoblación es denominada un **dominio**, en general no sabemos cuántos elementos pertenecen a un dominio hasta obtener los resultados de la muestra. Por ejemplo, al diseñar una muestra para medir la intención de voto de los Colombianos el interés se centra en conocer el total de personas que votarán por los diferentes candidatos pero previo a los resultados no se conoce cuántos votarán por cada uno.

</div> 


## Estimación de un dominio: Notación

El total de un dominio es: 

$$\sum_{U_d}y_k$$

con $U_d$ la población que compone al dominio.

Sea $$y_{dk}=\begin{cases}y_k \hspace{0.2cm}\text{si } k\in U_d \\ 0 \hspace{0.4cm} \text{en otro caso}\end{cases}$$

## Estimación de un dominio: Notación

<br>

Así $t_{yd}=\sum_{U}y_{dk}$ será el total de la variable de interés.

. . . 

<br>
Si $y_{dk}=1$ cuando $k \in U_d$ entonces $N_d=\sum_Uy_{k_d}$ es el tamaño poblacional del dominio.

. . . 

<br>
Luego la media del dominio es: $$\overline{y}_{Ud}=\frac{t_{yd}}{N_d}$$

## Estimación de un dominio: Ejemplo

- A nivel general el estimador de Horvitz-Thompson es:
$$\widehat{t}_{yd}=\sum_{s}\frac{y_{dk}}{\pi_k}$$
- Particularmente para MAS se tiene que:
$$\widehat{t}_{yd}=\frac{N}{n}\sum_{s}y_{dk}$$

$$\widehat{V}(\widehat{t}_{yd})=\frac{N^2}{n}\left(1-\frac{n}{N}\right)S^2_{y_ds}$$

## Estimación de un dominio: Aplicación

**Ejemplo:**  
Suponga que por medio de un muestreo a hogares se desea determinar la estructura del gasto según los ingresos familiares. El cliente desea estimar un cuadro de salida así:

```{r}
library(kableExtra)

data.frame(
  "Gasto" = c("Vivienda", "Alimentación", "Educación", "Transporte", "Esparcimiento", "Otros", "Total"),
  "Total < 2 SMMLV" = rep("", 7),
  "CVE (%) < 2 SMMLV" = rep("", 7),
  "Total 2 a 4 SMMLV" = rep("", 7),
  "CVE (%) 2 a 4 SMMLV" = rep("", 7),
  "Total > 4 SMMLV" = rep("", 7),
  "CVE (%) > 4 SMMLV" = rep("", 7),
  "Total General" = rep("", 7),
  "CVE (%) Total" = rep("", 7)
) %>% janitor::clean_names() |> 
  kbl(align = "lrrrrrrrr", booktabs = TRUE, linesep = "", caption = "Total de gasto de las familias en la población según ingresos familiares.") %>%
  kable_styling(full_width = TRUE, font_size = 16)

```

## Estimación de un dominio: Aplicación

1. _Ejemplo Hogares - Marco Muestral.xls_ seleccione una muestra por $MAS(N, 10)$.
2. _Dominio Hogares.xls_ estime en Excel el cuadro de salida solicitado por el cliente.
3. _Dominio Hogares.xls_ asigne arbitrariamente los códigos de hogares seleccionados en el literal 1 y documente la base.
4. _Dominio Hogares.xls_ suba los datos a _R_.
5. Haga un cruce de los datos con la muestra y la base con la información levantada de tal forma que los pesos muestrales queden en el archivo _Dominio Hogares.xls_.
6. Estime en **R** el cuadro de salida solicitado por el cliente.


```{r}
library(countdown)
countdown(minutes = 35, seconds = 00,  right = 0)
```

## Estimación de un dominio: Aplicación

<span style="color:#FF8D21"> Tu turno </span>

<div style="text-align: justify;">

Lohr (1999) En el censo de Agricultura de Estados Unidos que se realiza cada 5 años, se reúnen datos de todas las fincas-granjas donde se producen y venden más de \$100.000 USD en productos agrícolas al mes. Dentro de las variables que se miden está el número de granjas y los acres^[Un acre es una medida de superficie usada en agricultura equivalente a 43560 $pies^2$] dedicados a las granjas. El archivo **agpop.sav** contiene los datos de la población medida en el censo de $N=3078$. El archivo **Agrsrs.sav** contiene los datos de una muestra obtenida mediante el diseño $MAS(3078, 300)$. Estime el promedio y la cantidad de acres dedicados a la agricultura en el año 1992 en los Estados Unidos.

</div>

## Codigo R

Cargue de los datos

```{r, echo=TRUE}
#remotes::install_github("tidy-survey-r/srvyrexploR")
library(pacman)
p_load(tidyverse, survey, srvyr, remotes, haven, srvyrexploR, skimr)

censo <- "https://github.com/jgbabativam/Muestreo-I/raw/main/datos/agpop.sav"
encuesta <- "https://github.com/jgbabativam/Muestreo-I/raw/main/datos/Agrsrs.sav"

marco <- read_sav(censo)
datos <- read_sav(encuesta)
```

Explore los datos usando `skim()` y `glimpse()`

## Codigo R: Objeto de diseño

<br><br>
```{r, echo=TRUE}

datos$FEXP <- nrow(marco)/nrow(datos)

dsg <- datos |> 
       as_survey_design(ids = 1,
                        weights = FEXP,
                        nest = T)
```

## Codigo R: Estimación

<br><br>

```{r, echo=TRUE}

(estimacion <- dsg |> 
                 summarise(Total = survey_total(acres92, vartype = c("se", "cv", "ci")),
                           Promedio = survey_mean(acres92, vartype = c("se", "cv", "ci"))))

ty <- sum(marco$acres92)
ybU <- mean(marco$acres92)
```

. . . 

¿Cómo estimaría el la proporción de condados con menos de 200.000 acres de granjas?. ¿A partir de los universos del marco, cree que esta fue una buena muestra?

## Estimación de un dominio: Promedio

**MAS**


- $\overline{y}_{Ud}=\frac{t_{yd}}{N_d}=\frac{N/n\sum_{U}y_{dk}}{N_d}$
- $\overline{y}_{sd}=\frac{\widehat{t}_{yd}}{\widehat{N}_d}=\frac{N/n\sum_{s}y_{dk}}{N/n\sum_{s}z_{dk}}=\frac{\sum_{s}y_{dk}}{n_d}$, con $z_{dk}=1$ si $k \in U_d$

. . . 

Puesto que la cantidad del numerador y del denominador son variables aleatorias el estimador se denomina de razón y la estimación de la varianza se obtiene por aproximación mediante el método de linealización de Taylor.

## Estimación de un dominio: Promedio

<span style="color:#FF8D21"> Tu turno </span>

<br><br>

Para cada región estime el promedio y el total de acres por condado en 1992. 

```{r}
library(countdown)
countdown(minutes = 5, seconds = 00,  right = 0)
```

# MUESTREO ESTRATIFICADO {background-color="#0077b6"}

## Definiciones

1. $U=\{1,2,\ldots,N\}$ sea $\{U_1, U_2, \ldots, U_H\}$ una partición de $U$.
2. $U_h, h=1,\ldots,H$ se aplica de forma **INDEPENDIENTE** el diseño muestral $P_h(\cdot)$.
3. $t_y=\sum_Uy_k=\sum_{h=1}^Ht_{yh}$ de tal manera que el estimador insesgado de $t_y$ es:

\begin{align*}
\widehat{t}_y=\sum_{h=1}^H\widehat{t}_{yh}
\end{align*}

\begin{align*}
\widehat{V}\left(\widehat{t}_y\right)=\widehat{V}\left(\sum_{h=1}^H\widehat{t}_{yh}\right)=\sum_{h=1}^H\widehat{V}\left(\widehat{t}_{yh}\right)
\end{align*}

## Observaciones

1. Cada estrato $U_h$ es de tamaño $N_h$, así $\sum_{h=1}^HN_h=N$.
2. Una partición de $U$ es:
 - $N_h\neq0, h=1,\ldots,H.$
 - $U_i \bigcap U_j=\emptyset, i\neq j; i,j=1,\ldots,H$
 - $\bigcup_{h=1}^HU_h=U$
 
3. **Estrato es diferente de dominio**, los estratos se construyen a partir del diseño de la muestra, los dominios no. Por tanto la manera de hacer estimación es diferente.

## Razones para estratificar

<div style="text-align: justify;">

1. Minimizar varianza. Por ejemplo, el DANE en las encuestas económicas estratifica por empresas grandes, medianas y pequeñas.
2. Necesidad de contar con información con alta precisión para algunos niveles de desagregación. Por ejemplo, en un estudio en Bogotá se desean estimaciones por localidad pero de no controlarse la muestra es posible que salgan muy pocos elementos para algunas localidades. 
3. Reducción de costos. Por ejemplo, los gastos de desplazamiento pueden llegar a aumentar de manera considerable los costos de un proyecto entonces es posible estratificar por ciudades grandes, intermedias y pequeñas.

</div>

## Problemas técnicos de estratificar

<div style="text-align: justify;">

1. La cantidad de estratos es inversamente proporcional a la varianza y proporcional a los costos. En general al llegar a determinado número de estratos no se gana mucho en disminuir varianza y por el contrario se invierte mucho dinero.
2. Delimitación de los estratos (Hidroglou, Dalenius, Análisis multivariante de clúster).
3. Variable de estratificación - ¿con respecto a qué variable se debe estratificar?.
4. Asignación de muestra por estratos.

</div>

## Muestreo ESTMAS

Un caso particular es cuando se estratifica y cada uno de los estratos se aplica de manera independiente un $MAS(N_h,n_h)$. Encuesta de Anual de servicios, manufacturera y comercio (DANE).

1. $\widehat{t}_{yh}=\sum_{sh}\frac{N_h}{n_h}y_k$
2. $\widehat{t}_{y}=\sum_{h=1}^H\widehat{t}_{yh}=\sum_{h=1}^H\sum_{sh}\frac{N_h}{n_h}y_k$
3. $\widehat{V}\left(\widehat{t}_{yh}\right)=\frac{N_h^2}{n_h}\left(1-\frac{n_h}{N_h}\right)S^2_{ysh}$
4. $\widehat{V}\left(\widehat{t}_{y}\right)=\sum_{h=1}^H\widehat{V}\left(\widehat{t}_{yh}\right)=\sum_{h=1}^H\frac{N_h^2}{n_h}\left(1-\frac{n_h}{N_h}\right)S^2_{ysh}$ 

## Ejercicio

<span style="color:#FF8D21"> Tu turno </span>

Use las bases **Agpop.sav** y **AgStrat.sav** que corresponde a una muestra usando un diseño ESTMAS y realice los siguientes ejercicios:

1. Seleccione una muestra de **Agpop.sav** teniendo en cuenta los mismos $n_h$ de **AgStrat.sav**
2. Estime el promedio de acres por región con sus respectivos errores de muestreo (hágalo sacando las medidas de resumen $N_h$, $n_h$, $S^2$).
3. Estime en R el promedio de acres por región con sus respectivos errores de muestreo.

## Ejercicio

Suponga que se planea un muestreo estratificado que permita medir la intención de voto de los colombianos en las próximas elecciones presidenciales. Se ha decidido partir la población en 3 estratos. El analista Estadístico propone hacer en la primera etapa los siguientes diseños muestrales:


- Estrato 1: Diseño de inclusión forzosa (censo).
- Estrato 2: Diseño de Probabilidad Proporcional al Tamaño (PPT), $x_k$ es la población de 18 años o más en cada ciudad.
- Estrato 3: Muestreo Aleatorio Simple.

. . . 

Determine las fórmulas necesarias para calcular el total (con su cve) de personas que votarán en las próximas elecciones. ¿Cómo estimaría la proporción de personas que están a favor del candidato $A$?.

## Ejercicio

Se realizó un muestreo de sedes educativas mediante un diseño ESTMAS estratificando por NSE. Con el objetivo de hacer auditoria de los recursos del estado, se investigó por la cantidad de dinero (en millones de pesos) que el estado había girado a los colegios, los resultados son:

<div style="font-size: 0.6em;">

 **NSE** |  $N_h$ | $n_h$ | $\sum_{s_h}y_k$ | $s^2_{yh}$ |
|---------|-----------|-----------|---------------------|----------------|
| 1       | 400       | 98        | 2361.8             | 5575           |
| 2       | 30        | 10        | 256                | 4064           |
| 3       | 61        | 37        | 9901.2             | 347556         |
| 4       | 18        | 6         | 1074               | 22798          |
| 5       | 70        | 39        | 11454.3            | 123578         |
| 6       | 120       | 21        | 697.2              | 9795           |

</div>

Estime el total de recursos girados a los colegios de la población y por NSE, calcule intervalos de confianza al 95\% y muestre los cve.


## Ejercicio

Se desea lanzar un nuevo producto a un target específico pero se desea saber si la preferencia depende del género para tomar una decisión sobre como enfocar la publicidad. A partir de un muestreo ESTMAS se levantaron los siguientes datos:

<div style="font-size: 0.6em;">

**Ciudad** | $N_h$ | $n_h$ | **Mujeres (%)**  
|----------|-------|-------|-----------------|
| Medellín | 9100  | 636   | 38              |
| Ibagué   | 1950  | 451   | 27              |
| Barranquilla | 5500 | 481 | 18              |
| Bogotá   | 10850 | 611   | 19              |
| Cúcuta   | 2100  | 493   | 36              |
| Bucaramanga | 5500 | 575 | 13              |
| Cali     | 9000  | 588   | 26              |

</div>

Estime la proporción de mujeres de la población que preferirán el producto, calcule el cve.
 

```{r}
#pagedown::chrome_print("path-to-file.html")
```

# GRACIAS! {background-color="#ddf3ff"}

# Referencias

- Gutiérrez, H. A. (2016). Estrategias de muestreo: Diseño de encuestas y estimación de parámetros. Ediciones de la U.

- Lohr, S. L. (2021). Sampling: design and analysis. Chapman and Hall/CRC.

- Särndal, C. E., Swensson, B., & Wretman, J. (2003). Model assisted survey sampling. Springer Science & Business Media.

- Valliant, R., Dever, J. A., & Kreuter, F. (2013). Practical tools for designing and weighting survey samples (Vol. 1). New York: Springer.


# Citación y derechos de autor

Este material ha sido creado por [Giovany Babativa-Márquez](https://github.com/jgbabativam) y es de libre distribución bajo la licencia [Creative Commons Attribution-ShareAlike 4.0](https://creativecommons.org/licenses/by-sa/4.0/).

Si se copia parcial o totalmente, debe citar la fuente como:

> Babativa-Márquez, J.G. *Diapositivas del curso de muestreo probabilístico*. URL: https://jgbabativam.github.io/Muestreo-I/Semana3.html. 2024.
